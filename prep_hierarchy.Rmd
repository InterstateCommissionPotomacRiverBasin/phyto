---
title: "R Notebook"
output: html_notebook
---
Load the __tidyverse__ for data manipulation.
```{r, message=FALSE}
library(tidyverse)
```

Connect to ITIS postgreSQL database.
```{r}
source("conn_postgres.R")
on.exit(dbDisconnect(con), add = TRUE)
```

Import taxa hierarchy data from the database.
```{r}
hier.df <- tbl(conn, "hierarchy") %>% 
  data.frame()
```

```{r}
phyto.list <- list()
phyto.list["diatoms"] <- "630578-969910-969912-969914-969917-2287"
phyto.list["dinoflagellates"] <- "630578-590735-9873"
phyto.list["cyanobacteria"] <- "50-956096-956108"
phyto.list["chlorophyta"] <- "202422-954898-846493"
phyto.list["charophyta"] <- "202422-954898-846494"
phyto.list["idymozoidae"] <- "202423-914154-914155-914160-53963-914169-54556-55189-55621-55653-55857"
phyto.list["mastigophora"] <- "630577-43781-43782"
phyto.list["euglenophyceae "] <- "630577-9601-9602"
phyto.list["methanosarcinales"] <- "630578-590735-1447-1448"
phyto.list["chromista"] <- "630578-590735"
```

```{r}
phyto.df <- hier.df %>% 
  filter(grepl(paste(phyto.list, collapse = "|"), hierarchy_string))
```

Import synonym data from the database. This information is used to identify 
and convert invalid tsn's to accepted tsn's.
```{r}
syn.df <- tbl(conn, "synonym_links") %>% 
  select(1:2) %>% 
  data.frame()
```

Import NODC data from the database. Several taxa in the database were assigned 
a NODC code but not a tsn. Many of the NODC codes can be correctly linked to 
an accepted tsn using this table. Leading and trailing white space is removed 
from the `nodc_id` column. Additionally, if a leading zero is present in the 
`nodc_id` column, then it is removed to be consistant with the NODC code 
format found in the CBP data.
```{r}
nodc.df <- tbl(conn, "nodc_ids") %>% 
  select(nodc_id, tsn) %>% 
  data.frame() %>% 
  mutate(nodc_id = trimws(nodc_id),
         nodc_id = gsub("^[0]", "", nodc_id)) %>% 
  rename(nodccode = nodc_id,
         nodc_tsn = tsn)
```

CBP taxonomic count data is imported and `Methods` other than "PH", ,
are excluded from the data frame. All column names are converted to 
lowercase to make them easier to type. Several of the NODC codes 
contain character values that are not present in the ITIS NODC codes. 
These character values were appended on to valid NODC codes to identify 
taxa (e.g., species or subspecies) that are not in the NODC database. 
Numeric values are extracted from the `nodccode` column and any leading 
zeros are removed. 
```{r}
bay.df <- data.table::fread("data/LivingResourcesReportedHUC8.csv",
                            data.table = FALSE) %>% 
  # Removes methods with prefix "BE" (Tidal Benthic Taxa Enumeration) or blanks.
  filter(grepl("PH", Method)) %>% 
  #  rename(tsn = TSN, nodc_id = NODCCode) %>% 
  rename_all(tolower) %>% 
  mutate(nodc_num = gsub("[^0-9]", "", nodccode),
         nodc_num = gsub("^[0]", "", nodc_num),
         nodc_alpha = gsub("\\d+|NA", "", nodccode))
```


```{r}
bay.df <- bay.df %>% 
  left_join(nodc.df, by = c("nodc_num" = "nodccode")) %>% 
  mutate(final_tsn = if_else(
    !is.na(nodc_tsn) & tsn == 0,
    nodc_tsn,
    tsn),
    final_tsn = case_when(
      nodc_num == "7030526" ~ as.integer(3649),
      nodc_num == "7403100180" ~ as.integer(5204),
      TRUE ~ final_tsn
    ))
```


```{r}
bay.df <- bay.df %>% 
  left_join(syn.df, by = c("final_tsn" = "tsn")) %>% 
  mutate(
    final_tsn = if_else(
      is.na(tsn_accepted),
      final_tsn,
      tsn_accepted
    ))
```


```{r}
bay.tsn <- unique(bay.df$final_tsn)
```




```{r}
taxa.units <- tbl(conn, "taxonomic_units") %>% 
  select(tsn, n_usage, complete_name) %>% 
  #filter(tsn %in% bay.tsn) %>% 
  distinct() %>% 
  data.frame()

taxa.valid <- taxa.units %>% 
  filter(n_usage %in% c("valid", "accepted"))

test <- bay.df %>% 
  anti_join(taxa.units, by = c("final_tsn" = "tsn")) %>% 
  select(final_tsn, latinname) %>% 
  distinct()
```




Identify any TSN in the bay dataset that is not found in the phyto data frame.
```{r}
miss.vec <- setdiff(bay.tsn, phyto.df$tsn)
itis.miss <- hier.df %>% 
  filter(tsn %in% miss.vec)
```

```{r}
tsn.vec <- strsplit(phyto.df$hierarchy_string, "-") %>% 
  unlist() %>% 
  unique()
```


```{r}
kingdoms <- tbl(conn, "kingdoms") %>% 
  select(1:2) %>% 
  data.frame()
```


```{r}
taxa.units <- tbl(conn, "taxonomic_units") %>% 
  select(tsn, name_usage, kingdom_id, rank_id, complete_name) %>% 
#  filter(tsn %in% tsn.vec) %>% 
  distinct() %>% 
  data.frame() %>% 
  mutate(complete_name = trimws(complete_name),
         complete_name = gsub(" ", "_", complete_name))
```


```{r}
taxa.types <- tbl(conn, "taxon_unit_types") %>% 
  select(kingdom_id, rank_id, rank_name) %>% 
  distinct() %>% 
  arrange(rank_id) %>% 
  data.frame() %>% 
  left_join(kingdoms, by = "kingdom_id") %>% 
  mutate(rank_name = case_when(
    rank_id == 124 ~ "Section_Animalia",
    rank_id == 126 ~ "Subsection_Animalia",
    rank_id == 200 ~ "Section_Botany",
    rank_id == 210 ~ "Subsection_Botany",
    TRUE ~ rank_name
  )) %>% 
  mutate_if(is.character, trimws)
```


```{r}
taxa.df <- left_join(taxa.units, taxa.types, by = c("kingdom_id", "rank_id")) %>% 
  select(-kingdom_id, -rank_id, -kingdom_name) %>% 
  mutate_if(is.character, tolower)
```


```{r}
split.df <- strsplit(hier.df$hierarchy_string, "-") %>% 
  unlist() %>% 
  unique() %>% 
  data.frame(tsn = as.numeric(.)) %>% 
  select(tsn)
```


```{r}
join.df <- left_join(split.df, taxa.df, by = "tsn")
```

```{r}
hier.long <- hier.df %>% 
  filter(tsn %in% unique(bay.df$final_tsn)) %>% 
  mutate(hyphen_count = stringr::str_count(hierarchy_string, '-')) %>% 
  separate(hierarchy_string,
           into = paste("tsn", seq(1:(max(.$hyphen_count) + 1)), sep = "_"),
           extra = "drop") %>% 
  select(-parent_tsn, -level, -childrencount, -hyphen_count) %>% 
  rename(final_tsn = tsn) %>% 
  gather(col_name, tsn, -final_tsn, na.rm = TRUE) %>% 
  select(-col_name) %>% 
  mutate(tsn = as.numeric(tsn))
```

```{r}
sub.final <- left_join(hier.long, taxa.df,  by = "tsn") %>% 
  select(-tsn, -name_usage) %>% 
  spread(rank_name, complete_name) 
```


```{r}
hier.vec <- c("kingdom", "subkingdom", "infrakingdom", 
              "superdivision", "division", "subdivision", "infradivision",
              "superphylum", "phylum", "subphylum", "infraphylum", 
              "superclass", "class", "subclass", "infraclass", 
              "superorder", "order", "suborder", "infraorder", 
              "section_animalia", "subsection_animalia", 
              "superfamily", "family", "subfamily", 
              "tribe", "subtribe", 
              "genus", "subgenus", 
              "section_botany", "subsection_botany",
              "species", "subspecies", 
              "variety", "form", "race", "stirp", "morph", "aberration", "unspecified")

hier.temp <- data.frame(hierarchy = hier.vec, na_col = NA, stringsAsFactors = FALSE) %>% 
  spread(hierarchy, na_col) %>% 
  select(hier.vec)
```


```{r}
hier.final <- bind_rows(hier.temp, sub.final) %>% 
  select(final_tsn, hier.vec) %>% 
  filter(!is.na(final_tsn))
```

```{r}
bay.final <- left_join(bay.df, hier.final, by = "final_tsn") %>% 
  mutate(species = if_else(latinname == "Navicula beyrichiana", "navicula_beyrichiana", species),
         subspecies = if_else(latinname == "Nitzschia vitrea salinarum", "salinarum", subspecies)) %>% 
  select(-nodc_num, nodc_alpha)

bay.final <- bay.final[, !colSums(is.na(bay.final)) %in% nrow(bay.final)]
```

